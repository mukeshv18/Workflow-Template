
name: Unit Tests (Reusable)

on:
  workflow_call:
    inputs:
      type:
        description: "Build type to test with: maven | gradle | npm"
        required: false
        type: string
        default: maven
      maven_cmd:
        description: "Maven command (override if needed)"
        required: false
        type: string
        default: "mvn -B"
      working-directory:
        description: "Directory to run tests in"
        required: false
        type: string
        default: "."
      java-version:
        description: "Java version for Maven/Gradle"
        required: false
        type: string
        default: "17"
      node-version:
        description: "Node.js version for npm"
        required: false
        type: string
        default: "20"
    secrets:
      NPM_TOKEN:
        description: "Optional npm token for private registry access"
        required: false

jobs:
  run-tests:
    # Switch to 'windows-latest' if you need Windows and batch tooling.
    runs-on: ubuntu-latest
    env:
      MAVEN_CMD: ${{ inputs.maven_cmd }}
      BUILD_TYPE: ${{ inputs.type }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: ğŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¦ Start Unit Test Stage
        run: |
          echo "::group::Unit Test Stage"
          echo "Build type: '${BUILD_TYPE}'"
          echo "Working directory: '${{ inputs.working-directory }}'"
          echo "::endgroup::"

      - name: âœ… Validate build type
        run: |
          case "$BUILD_TYPE" in
            maven|gradle|npm) echo "Supported build type: $BUILD_TYPE";;
            *)
              echo "::error::Unsupported build type: $BUILD_TYPE"
              exit 1
              ;;
          esac

      # ---------- Maven ----------
      - name: â˜• Setup Java (Maven)
        if: ${{ inputs.type == 'maven' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java-version }}
          cache: maven

      - name: ğŸ”§ Maven Test
        if: ${{ inputs.type == 'maven' }}
        run: |
          set -euo pipefail
          echo "Running: $MAVEN_CMD test"
          $MAVEN_CMD test
        # If you need to pass settings.xml or profiles, you can add them here.

      # ---------- Gradle ----------
      - name: â˜• Setup Java (Gradle)
        if: ${{ inputs.type == 'gradle' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java-version }}
          cache: gradle

      - name: ğŸ”§ Gradle Test
        if: ${{ inputs.type == 'gradle' }}
        run: |
          set -euo pipefail
          if [ -x "./gradlew" ]; then
            echo "Using Gradle wrapper"
            ./gradlew test --stacktrace
          else
            echo "Using system Gradle"
            gradle test --stacktrace
          fi

      # ---------- npm ----------
      - name: ğŸŸ© Setup Node.js
        if: ${{ inputs.type == 'npm' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: ğŸ” Configure npm auth (optional)
        if: ${{ inputs.type == 'npm' && secrets.NPM_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: ğŸ“¦ Install dependencies (npm)
        if: ${{ inputs.type == 'npm' }}
        run: |
          set -euo pipefail
          # Prefer reproducible installs; fallback if package-lock is absent
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: ğŸ§ª npm test
        if: ${{ inputs.type == 'npm' }}
        run: |
          set -euo pipefail
          npm test

      - name: âœ… Unit tests passed
        if: ${{ success() }}
        run: echo "Unit tests passed"

      - name: âŒ Unit tests failed
               if: ${{ failure() }}
